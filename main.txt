#include <WiFi.h>
#include <WebServer.h>
#include <DHT.h>
#include <ESP32Servo.h>

// ========== WiFi Credentials ==========
const char* ssid = "Efti";
const char* password = "efti2001";

// ========== Create Objects ==========
WebServer server(80);
DHT dht(15, DHT11);
Servo waterServo;

// ========== Pin Definitions ==========
// Motor Driver Pins
#define ENA 25
#define IN1 13
#define IN2 12
#define IN3 14
#define IN4 27
#define ENB 26

// Flame Sensor Pins
#define FLAME_LEFT 32
#define FLAME_MIDDLE 33
#define FLAME_RIGHT 34

// Gas Sensor Pin
#define GAS_SENSOR 35

// DHT11 Pin
#define DHT_PIN 15

// Servo Pin
#define SERVO_PIN 23

// Relay Pins
#define PUMP_RELAY 18
#define FAN_RELAY 19

// LED and Buzzer Pins
#define RED_LED 21
#define BLUE_LED 22
#define BUZZER 4

// ========== Global Variables ==========
float temperature = 0;
float humidity = 0;
bool autoMode = true;
bool manualPumpState = false;
bool manualFanState = false;
String statusMessage = "System Ready";

int motorSpeed = 200;
unsigned long fanStartTime = 0;
bool fanTimerActive = false;
bool gasWasDetected = false;

// ========== Setup Function ==========
void setup() {
  Serial.begin(115200);
  Serial.println("\n=== Firefighting Robot Starting ===");
  
  // Motor pins
  pinMode(ENA, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  pinMode(ENB, OUTPUT);
  
  // Sensor pins
  pinMode(FLAME_LEFT, INPUT);
  pinMode(FLAME_MIDDLE, INPUT);
  pinMode(FLAME_RIGHT, INPUT);
  pinMode(GAS_SENSOR, INPUT);
  
  // Relay pins
  pinMode(PUMP_RELAY, OUTPUT);
  pinMode(FAN_RELAY, OUTPUT);
  digitalWrite(PUMP_RELAY, HIGH);  // OFF
  digitalWrite(FAN_RELAY, HIGH);   // OFF
  
  // LED and Buzzer pins
  pinMode(RED_LED, OUTPUT);
  pinMode(BLUE_LED, OUTPUT);
  pinMode(BUZZER, OUTPUT);
  digitalWrite(RED_LED, LOW);
  digitalWrite(BLUE_LED, LOW);
  digitalWrite(BUZZER, LOW);
  
  // Initialize DHT
  dht.begin();
  
  // Initialize Servo (SIMPLE METHOD THAT WORKED!)
  waterServo.attach(SERVO_PIN);
  waterServo.write(90);  // Center position
  delay(500);
  
  // Test servo
  Serial.println("Testing servo...");
  waterServo.write(30);
  delay(500);
  waterServo.write(150);
  delay(500);
  waterServo.write(90);
  Serial.println("Servo OK!");
  
  // Test buzzer
  Serial.println("Testing buzzer...");
  digitalWrite(BUZZER, HIGH);
  delay(300);
  digitalWrite(BUZZER, LOW);
  Serial.println("Buzzer OK!");
  
  stopMotors();
  
  // Connect WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi Connected!");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nWiFi Failed!");
  }
  
  // Web server routes
  server.on("/", handleRoot);
  server.on("/status", handleStatus);
  server.on("/move", handleMove);
  server.on("/stop", handleStop);
  server.on("/pumpon", handlePumpOn);
  server.on("/pumpoff", handlePumpOff);
  server.on("/fanon", handleFanOn);
  server.on("/fanoff", handleFanOff);
  server.on("/mode", handleMode);
  
  server.begin();
  Serial.println("Web Server Started!");
  Serial.println("============================\n");
}

// ========== Main Loop ==========
void loop() {
  server.handleClient();
  
  // Read sensors
  temperature = dht.readTemperature();
  humidity = dht.readHumidity();
  if (isnan(temperature)) temperature = 0;
  if (isnan(humidity)) humidity = 0;
  
  // Read flame sensors (Active LOW)
  bool flameLeft = (digitalRead(FLAME_LEFT) == LOW);
  bool flameMiddle = (digitalRead(FLAME_MIDDLE) == LOW);
  bool flameRight = (digitalRead(FLAME_RIGHT) == LOW);
  bool anyFlame = flameLeft || flameMiddle || flameRight;
  
  // Read gas sensor (Active LOW)
  bool gasDetected = (digitalRead(GAS_SENSOR) == LOW);
  
  // ========== AUTO MODE LOGIC ==========
  if (autoMode) {
    
    // ===== FIRE DETECTION =====
    if (anyFlame) {
      digitalWrite(RED_LED, HIGH);      // Red LED ON
      digitalWrite(BUZZER, HIGH);       // Buzzer ON
      
      if (flameMiddle) {
        // MIDDLE FIRE DETECTED
        statusMessage = "üî• FIRE AHEAD! Moving forward...";
        Serial.println(statusMessage);
        
        // Move forward a little
        
        moveForward();
        delay(300);  // Move for 800ms
        stopMotors();
        delay(200);
        
        // Spray water with servo sweep
        statusMessage = "üí¶ Spraying water ahead!";
        Serial.println(statusMessage);
        digitalWrite(PUMP_RELAY, LOW);  // Pump ON
        servoSweep4Times();
        digitalWrite(PUMP_RELAY, HIGH); // Pump OFF
        waterServo.write(90);           // Return to center
        delay(500);
        
      } else if (flameLeft) {
        // LEFT FIRE DETECTED
        statusMessage = "üî• FIRE LEFT! Turning left...";
        Serial.println(statusMessage);
        
        // Turn left a little
        turnLeft();
        delay(200);  // Turn for 600ms
        stopMotors();
        delay(200);
        
        // Spray water with servo sweep
        statusMessage = "üí¶ Spraying water on left!";
        Serial.println(statusMessage);
        digitalWrite(PUMP_RELAY, LOW);  // Pump ON
        servoSweep4Times();
        digitalWrite(PUMP_RELAY, HIGH); // Pump OFF
        waterServo.write(90);           // Return to center
        delay(500);
        
      } else if (flameRight) {
        // RIGHT FIRE DETECTED
        statusMessage = "üî• FIRE RIGHT! Turning right...";
        Serial.println(statusMessage);
        
        // Turn right a little
        turnRight();
        delay(200);  // Turn for 600ms
        stopMotors();
        delay(200);
        
        // Spray water with servo sweep
        statusMessage = "üí¶ Spraying water on right!";
        Serial.println(statusMessage);
        digitalWrite(PUMP_RELAY, LOW);  // Pump ON
        servoSweep4Times();
        digitalWrite(PUMP_RELAY, HIGH); // Pump OFF
        waterServo.write(90);           // Return to center
        delay(500);
      }
      
      digitalWrite(BUZZER, LOW);  // Turn off buzzer after action
      delay(1000);
      
    } else {
      // No fire detected
      digitalWrite(RED_LED, LOW);
      digitalWrite(BUZZER, LOW);
      stopMotors();
      statusMessage = "üîç Scanning for fire...";
    }
    
    // ===== GAS DETECTION =====
    if (gasDetected && !gasWasDetected) {
      // Gas just detected (first time)
      digitalWrite(BLUE_LED, HIGH);
      digitalWrite(BUZZER, HIGH);       // Buzzer ON for gas
      digitalWrite(FAN_RELAY, LOW);     // Fan ON
      fanStartTime = millis();
      fanTimerActive = true;
      gasWasDetected = true;
      statusMessage = "üí® SMOKE DETECTED! Fan ON for 15 seconds";
      Serial.println(statusMessage);
    }
    
    // Check fan timer
    if (fanTimerActive && (millis() - fanStartTime >= 1000)) {
      // 15 seconds passed
      digitalWrite(FAN_RELAY, HIGH);    // Fan OFF
      digitalWrite(BUZZER, LOW);        // Buzzer OFF
      fanTimerActive = false;
      statusMessage = "‚úì Smoke cleared. Fan stopped.";
      Serial.println(statusMessage);
    }
    
    // Reset gas detection flag when no gas
    if (!gasDetected) {
      gasWasDetected = false;
      digitalWrite(BLUE_LED, LOW);
      if (!fanTimerActive) {
        digitalWrite(BUZZER, LOW);
      }
    }
    
  } else {
    // ===== MANUAL MODE =====
    // LEDs still work as indicators
    if (anyFlame) {
      digitalWrite(RED_LED, HIGH);
      digitalWrite(BUZZER, HIGH);
    } else {
      digitalWrite(RED_LED, LOW);
      digitalWrite(BUZZER, LOW);
    }
    
    if (gasDetected) {
      digitalWrite(BLUE_LED, HIGH);
    } else {
      digitalWrite(BLUE_LED, LOW);
    }
    
    // Manual pump control
    if (manualPumpState) {
      digitalWrite(PUMP_RELAY, LOW);
    } else {
      digitalWrite(PUMP_RELAY, HIGH);
    }
    
    // Manual fan control
    if (manualFanState) {
      digitalWrite(FAN_RELAY, LOW);
    } else {
      digitalWrite(FAN_RELAY, HIGH);
    }
  }
  
  delay(50);
}

// ========== Servo Sweep Function (4 TIMES, 30-150 degrees) ==========
void servoSweep4Times() {
  Serial.println("Starting 4 servo sweeps...");
  
  for (int sweep = 0; sweep < 4; sweep++) {
    Serial.print("Sweep #");
    Serial.println(sweep + 1);
    
    // Sweep from 30 to 150 degrees
    for (int pos = 30; pos <= 150; pos += 5) {
      waterServo.write(pos);
      delay(30);  // Smooth movement
    }
    
    // Sweep back from 150 to 30 degrees
    for (int pos = 150; pos >= 30; pos -= 5) {
      waterServo.write(pos);
      delay(30);
    }
  }
  
  Serial.println("Servo sweep complete!");
}

// ========== Motor Control Functions ==========
void moveForward() {
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void moveBackward() {
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
}

void turnLeft() {
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
}

void turnRight() {
  analogWrite(ENA, motorSpeed);
  analogWrite(ENB, motorSpeed);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void stopMotors() {
  analogWrite(ENA, 0);
  analogWrite(ENB, 0);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}

// ========== Web Server Handlers ==========

void handleRoot() {
  String html = R"=====(
<!DOCTYPE html>
<html>
<head>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta charset='UTF-8'>
    <title>Firefighting Robot Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            font-size: 2em;
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255,107,107,0.5);
            margin-bottom: 10px;
        }
        .mode-badge {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(245,87,108,0.4);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .card h2 {
            color: #4ecca3;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .status-display {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .sensor-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }
        .sensor-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .sensor-value {
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .sensor-unit {
            font-size: 1.2em;
            opacity: 0.8;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 350px;
            margin: 20px auto;
        }
        .control-btn {
            background: linear-gradient(135deg, #4ecca3 0%, #3ba883 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(78,204,163,0.4);
            transition: all 0.2s;
            touch-action: manipulation;
        }
        .control-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(78,204,163,0.4);
        }
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78,204,163,0.6);
        }
        .btn-stop {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .action-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245,87,108,0.4);
            transition: all 0.3s;
        }
        .action-btn:active {
            transform: scale(0.95);
        }
        .btn-on {
            background: linear-gradient(135deg, #4ecca3 0%, #3ba883 100%);
            box-shadow: 0 4px 15px rgba(78,204,163,0.4);
        }
        .btn-off {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
        .mode-btn {
            width: 100%;
            background: linear-gradient(135deg, #ffd93d 0%, #f0c929 100%);
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255,217,61,0.4);
            transition: all 0.3s;
            margin-top: 10px;
        }
        .mode-btn:active {
            transform: scale(0.98);
        }
        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .fire-ind { background: #ff6b6b; box-shadow: 0 0 10px #ff6b6b; }
        .gas-ind { background: #4ecca3; box-shadow: 0 0 10px #4ecca3; }
        @media (max-width: 768px) {
            h1 { font-size: 1.5em; }
            .sensor-value { font-size: 2em; }
            .control-btn { padding: 15px; font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div class='header'>
        <h1>üî• FIREFIGHTING ROBOT CONTROL üöí</h1>
        <span class='mode-badge' id='modeDisplay'>AUTO MODE</span>
    </div>
    
    <div class='container'>
        <!-- Status Card -->
        <div class='card'>
            <h2>üìä System Status</h2>
            <div class='status-display' id='statusMsg'>Initializing...</div>
            <div style='text-align: center; margin-top: 15px; font-size: 1.1em;'>
                <span class='indicator fire-ind'></span>Fire Alert
                <span style='margin-left: 20px;'></span>
                <span class='indicator gas-ind'></span>Gas Alert
            </div>
        </div>
        
        <!-- Sensors Row -->
        <div class='row'>
            <!-- Temperature & Humidity Card -->
            <div class='card'>
                <h2>üå°Ô∏è Environment Sensors</h2>
                <div class='sensor-grid'>
                    <div class='sensor-box'>
                        <div class='sensor-label'>TEMPERATURE</div>
                        <div class='sensor-value' id='tempValue'>--</div>
                        <div class='sensor-unit'>¬∞C</div>
                    </div>
                    <div class='sensor-box'>
                        <div class='sensor-label'>HUMIDITY</div>
                        <div class='sensor-value' id='humidValue'>--</div>
                        <div class='sensor-unit'>%</div>
                    </div>
                </div>
            </div>
            
            <!-- Manual Controls Card -->
            <div class='card'>
                <h2>üéÆ Movement Control</h2>
                <div class='control-grid'>
                    <div></div>
                    <button class='control-btn' 
                            onmousedown='startMove("forward")' 
                            ontouchstart='startMove("forward")' 
                            onmouseup='stopMove()' 
                            ontouchend='stopMove()' 
                            onmouseleave='stopMove()'>
                        ‚ñ≤
                    </button>
                    <div></div>
                    
                    <button class='control-btn' 
                            onmousedown='startMove("left")' 
                            ontouchstart='startMove("left")' 
                            onmouseup='stopMove()' 
                            ontouchend='stopMove()' 
                            onmouseleave='stopMove()'>
                        ‚óÑ
                    </button>
                    <button class='control-btn btn-stop' 
                            onclick='stopMove()'>
                        ‚¨õ
                    </button>
                    <button class='control-btn' 
                            onmousedown='startMove("right")' 
                            ontouchstart='startMove("right")' 
                            onmouseup='stopMove()' 
                            ontouchend='stopMove()' 
                            onmouseleave='stopMove()'>
                        ‚ñ∫
                    </button>
                    
                    <div></div>
                    <button class='control-btn' 
                            onmousedown='startMove("backward")' 
                            ontouchstart='startMove("backward")' 
                            onmouseup='stopMove()' 
                            ontouchend='stopMove()' 
                            onmouseleave='stopMove()'>
                        ‚ñº
                    </button>
                    <div></div>
                </div>
            </div>
        </div>
        
        <!-- System Controls Row -->
        <div class='row'>
            <!-- Pump Control Card -->
            <div class='card'>
                <h2>üíß Water Pump Control</h2>
                <div class='action-buttons'>
                    <button class='action-btn btn-on' onclick='pumpOn()'>
                        ‚úì PUMP ON
                    </button>
                    <button class='action-btn btn-off' onclick='pumpOff()'>
                        ‚úó PUMP OFF
                    </button>
                </div>
            </div>
            
            <!-- Fan Control Card -->
            <div class='card'>
                <h2>üí® Ventilation Fan Control</h2>
                <div class='action-buttons'>
                    <button class='action-btn btn-on' onclick='fanOn()'>
                        ‚úì FAN ON
                    </button>
                    <button class='action-btn btn-off' onclick='fanOff()'>
                        ‚úó FAN OFF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mode Control Card -->
        <div class='card'>
            <h2>‚öôÔ∏è Operation Mode</h2>
            <button class='mode-btn' onclick='toggleMode()'>
                üîÑ SWITCH MODE (AUTO ‚áÑ MANUAL)
            </button>
            <div style='text-align: center; margin-top: 15px; color: #ffd93d; font-size: 0.9em;'>
                <strong>AUTO MODE:</strong> Robot fights fire automatically<br>
                <strong>MANUAL MODE:</strong> Full remote control
            </div>
        </div>
        
        <!-- Footer -->
        <div style='text-align: center; margin: 30px 0; color: rgba(255,255,255,0.5); font-size: 0.9em;'>
            <p>ü§ñ IoT Firefighting Robot v2.0</p>
            <p>Real-time monitoring ‚Ä¢ Auto-refresh every 500ms</p>
        </div>
    </div>

    <script>
        let isMoving = false;
        let currentDirection = '';
        
        // Start movement (hold button)
        function startMove(direction) {
            if (isMoving && currentDirection === direction) return;
            
            isMoving = true;
            currentDirection = direction;
            
            fetch('/move?dir=' + direction)
                .then(response => response.text())
                .then(data => {
                    console.log('Moving: ' + direction);
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Stop movement (release button)
        function stopMove() {
            if (!isMoving) return;
            
            isMoving = false;
            currentDirection = '';
            
            fetch('/stop')
                .then(response => response.text())
                .then(data => {
                    console.log('Stopped');
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Pump ON
        function pumpOn() {
            fetch('/pumpon')
                .then(response => response.text())
                .then(data => {
                    console.log('Pump ON');
                    showToast('üíß Pump Activated');
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Pump OFF
        function pumpOff() {
            fetch('/pumpoff')
                .then(response => response.text())
                .then(data => {
                    console.log('Pump OFF');
                    showToast('üíß Pump Deactivated');
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Fan ON
        function fanOn() {
            fetch('/fanon')
                .then(response => response.text())
                .then(data => {
                    console.log('Fan ON');
                    showToast('üí® Fan Activated');
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Fan OFF
        function fanOff() {
            fetch('/fanoff')
                .then(response => response.text())
                .then(data => {
                    console.log('Fan OFF');
                    showToast('üí® Fan Deactivated');
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Toggle Mode
        function toggleMode() {
            fetch('/mode')
                .then(response => response.text())
                .then(data => {
                    console.log('Mode changed: ' + data);
                    showToast('üîÑ Mode: ' + data);
                    updateStatus();
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Update status from server
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Update temperature
                    document.getElementById('tempValue').innerText = data.temp;
                    
                    // Update humidity
                    document.getElementById('humidValue').innerText = data.humid;
                    
                    // Update status message
                    document.getElementById('statusMsg').innerText = data.status;
                    
                    // Update mode display
                    document.getElementById('modeDisplay').innerText = data.mode;
                })
                .catch(error => {
                    console.error('Status update error:', error);
                    document.getElementById('statusMsg').innerText = '‚ö†Ô∏è Connection Lost';
                });
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.innerText = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(78,204,163,0.9);
                color: #fff;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        // Auto-update status every 500ms
        setInterval(updateStatus, 500);
        
        // Initial update
        window.onload = function() {
            updateStatus();
            console.log('Firefighting Robot Control Panel Loaded');
        };
        
        // Prevent context menu on long press (mobile)
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>
)=====";
  
  server.send(200, "text/html", html);
}

// Status endpoint - returns JSON
void handleStatus() {
  String json = "{";
  json += "\"temp\":\"" + String(temperature, 1) + "\",";
  json += "\"humid\":\"" + String(humidity, 1) + "\",";
  json += "\"status\":\"" + statusMessage + "\",";
  json += "\"mode\":\"" + String(autoMode ? "AUTO MODE" : "MANUAL MODE") + "\"";
  json += "}";
  
  server.send(200, "application/json", json);
}

// Movement endpoint
void handleMove() {
  if (autoMode) {
    server.send(200, "text/plain", "In AUTO mode");
    return;
  }
  
  if (server.hasArg("dir")) {
    String direction = server.arg("dir");
    
    if (direction == "forward") {
      moveForward();
      statusMessage = "‚¨ÜÔ∏è Moving Forward";
    } else if (direction == "backward") {
      moveBackward();
      statusMessage = "‚¨áÔ∏è Moving Backward";
    } else if (direction == "left") {
      turnLeft();
      statusMessage = "‚¨ÖÔ∏è Turning Left";
    } else if (direction == "right") {
      turnRight();
      statusMessage = "‚û°Ô∏è Turning Right";
    }
    
    server.send(200, "text/plain", "Moving " + direction);
  } else {
    server.send(400, "text/plain", "No direction");
  }
}

// Stop endpoint
void handleStop() {
  stopMotors();
  statusMessage = "‚èπÔ∏è Stopped";
  server.send(200, "text/plain", "Stopped");
}

// Pump ON endpoint
void handlePumpOn() {
  if (autoMode) {
    server.send(200, "text/plain", "Auto mode active");
    return;
  }
  
  manualPumpState = true;
  digitalWrite(PUMP_RELAY, LOW);  // ON
  statusMessage = "üíß Pump manually activated";
  server.send(200, "text/plain", "Pump ON");
}

// Pump OFF endpoint
void handlePumpOff() {
  if (autoMode) {
    server.send(200, "text/plain", "Auto mode active");
    return;
  }
  
  manualPumpState = false;
  digitalWrite(PUMP_RELAY, HIGH);  // OFF
  statusMessage = "üíß Pump manually deactivated";
  server.send(200, "text/plain", "Pump OFF");
}

// Fan ON endpoint
void handleFanOn() {
  if (autoMode) {
    server.send(200, "text/plain", "Auto mode active");
    return;
  }
  
  manualFanState = true;
  digitalWrite(FAN_RELAY, LOW);  // ON
  statusMessage = "üí® Fan manually activated";
  server.send(200, "text/plain", "Fan ON");
}

// Fan OFF endpoint
void handleFanOff() {
  if (autoMode) {
    server.send(200, "text/plain", "Auto mode active");
    return;
  }
  
  manualFanState = false;
  digitalWrite(FAN_RELAY, HIGH);  // OFF
  statusMessage = "üí® Fan manually deactivated";
  server.send(200, "text/plain", "Fan OFF");
}

// Mode toggle endpoint
void handleMode() {
  autoMode = !autoMode;
  
  if (autoMode) {
    stopMotors();
    manualPumpState = false;
    manualFanState = false;
    digitalWrite(PUMP_RELAY, HIGH);  // OFF
    digitalWrite(FAN_RELAY, HIGH);   // OFF
    statusMessage = "ü§ñ AUTO MODE - Robot will fight fires automatically";
    server.send(200, "text/plain", "AUTO MODE");
  } else {
    stopMotors();
    statusMessage = "üéÆ MANUAL MODE - You have full control";
    server.send(200, "text/plain", "MANUAL MODE");
  }
}